<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>$FLEX is your life — Flexcoin</title>

  <!-- Favicon (404 방지: /public 경로 우선, 둘 다 시도) -->
  <link rel="icon" type="image/svg+xml" href="/public/favicon.svg">
  <link rel="alternate icon" href="/public/favicon.ico">
  <link rel="alternate icon" href="/favicon.ico">

  <!-- Whitepaper discoverability -->
  <link rel="alternate" hreflang="en" href="/public/whitepaper/en.pdf">
  <link rel="alternate" hreflang="ko" href="/public/whitepaper/ko.pdf">
  <link rel="alternate" hreflang="ja" href="/public/whitepaper/ja.pdf">
  <link rel="alternate" hreflang="zh" href="/public/whitepaper/zh.pdf">
  <link rel="alternate" hreflang="es" href="/public/whitepaper/es.pdf">
  <link rel="alternate" hreflang="de" href="/public/whitepaper/de.pdf">
  <link rel="alternate" hreflang="pt" href="/public/whitepaper/pt.pdf">
  <link rel="alternate" hreflang="it" href="/public/whitepaper/it.pdf">

  <style>
    :root{
      --bg:#11100d; --card:#1b1915; --text:#eadfbb; --muted:#b9a97a;
      --gold:#f4cc4f; --chip:#3a331c; --border:rgba(255,255,255,.08);
    }
    html,body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial;
      overflow-x:hidden; max-width:100vw; overscroll-behavior-x:none
    }
    body{ padding-top:64px; }
    *{box-sizing:border-box}
    a{color:inherit; text-decoration:none}
    body.noscroll{overflow:hidden}

    .topbar{
      position:fixed; inset:0 auto auto 0; right:0; top:0;
      display:flex; align-items:center; gap:.5rem; padding:.8rem 1rem;
      background:linear-gradient(180deg,rgba(0,0,0,.75),rgba(0,0,0,.35));
      backdrop-filter:blur(6px); z-index:9999; border-bottom:1px solid var(--border);
    }
    .brand{font-weight:800;color:var(--gold);line-height:1.15;white-space:nowrap}
    .spacer{flex:1}
    .btn{
      border:none;border-radius:.7rem;padding:.55rem .9rem;cursor:pointer;
      background:var(--gold);color:#000;font-weight:800;display:inline-block;white-space:nowrap
    }
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .lang{display:inline-flex;border-radius:.6rem;overflow:hidden;border:1px solid var(--border)}
    .lang button{background:var(--chip);padding:.5rem .75rem;border:0;color:var(--text);cursor:pointer}
    .lang button.active{background:var(--gold);color:#000;font-weight:800}
    .nav a{margin-left:.6rem; font-weight:700; color:var(--gold); opacity:.9; white-space:nowrap}
    .nav a:hover{opacity:1}

    @media(max-width:680px){
      .topbar{flex-wrap:wrap;gap:.4rem}
      .brand{flex:1 1 100%; font-size:1rem}
      .nav{order:3; width:100%; display:flex; gap:.8rem .6rem; flex-wrap:wrap}
      .btn{padding:.5rem .7rem}
      .lang{order:4}
    }

    .wrap{max-width:1100px;margin:0 auto;padding:1rem}
    .card{background:var(--card);border:1px solid var(--border);
      border-radius:18px;padding:16px;margin-top:1rem}
    .section-title{font-size:1.4rem;font-weight:900;margin:.4rem 0 1rem;color:var(--gold)}
    .muted{color:var(--muted);font-size:.95rem}

    .hero{background:#0f0e0c;border-radius:18px;overflow:hidden;border:1px solid var(--border)}
    .hero img{display:block;width:100%;height:auto}

    .tok-wrap{display:grid;grid-template-columns:320px 1fr;gap:18px}
    /* 도넛이 찌그러지지 않도록 정사각형 고정 */
    #donut{
      width:280px;
      height:280px;
      max-width:100%;
      aspect-ratio:1/1;
      display:block;
      margin:auto;
      background:#0f0e0c;
      border-radius:14px;
    }
    ul.legend{list-style:none;padding:0;margin:0;font-size:.95rem}
    ul.legend li{margin:.2rem 0;display:flex;align-items:center}
    .legend-dot{
      width:11px;height:11px;border-radius:50%;margin-right:6px;flex-shrink:0;
      border:1px solid rgba(0,0,0,.4);
    }
    #caps,#rates{margin-top:.35rem}
    #btn-presale-1,#btn-presale-2{margin-top:10px}
    .tokenomics-note{
      margin-top:.55rem;
      font-size:.9rem;
      color:var(--muted);
      line-height:1.45;
      text-align:left;
    }

    .countbox{border:1px solid var(--border);border-radius:14px;padding:14px;
      background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)}
    #countdown{font-weight:900;font-size:1.35rem}

    .wp-grid{display:flex;flex-wrap:wrap;gap:.5rem}
    .wp-note{margin-top:.5rem}

    .addr table{width:100%;border-collapse:collapse;font-size:.92rem}
    .addr td{padding:.45rem .55rem;border-bottom:1px dashed var(--border);word-break:break-all}
    .addr a{color:var(--gold);text-decoration:none}

    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .grid img{width:100%;height:auto;display:block;aspect-ratio:16/9;object-fit:cover;
      border-radius:12px;border:1px solid var(--border);background:#0f0e0c}
    @media(max-width:900px){
      .tok-wrap{grid-template-columns:1fr}
      .grid{grid-template-columns:repeat(2,1fr)}
      .addr td{font-size:.85rem}
    }

    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;
      align-items:center;justify-content:center;z-index:50;touch-action:none}
    .lightbox.show{display:flex}
    .lb-stage{position:relative;max-width:95vw;max-height:85vh;overflow:hidden;cursor:grab;border-radius:12px}
    .lb-img{user-select:none;pointer-events:auto;transform-origin:center center;display:block;max-width:none}
    .lb-toolbar{position:fixed;top:12px;right:12px;display:flex;gap:.4rem;z-index:60}
    .lb-toolbar .btn{padding:.4rem .6rem;border-radius:.6rem}
    .lb-hint{position:fixed;bottom:12px;left:12px;color:#ddd;font-size:.85rem;opacity:.8}

    .about-section{background:linear-gradient(180deg,#0a0a0a 0%, #111 100%);border:1px solid rgba(212,175,55,.25);
      border-radius:24px;padding:28px;margin:24px 0;box-shadow:0 10px 30px rgba(0,0,0,.35);color:#f1f1f1}
    .about-title{font-size:28px;font-weight:800;margin-bottom:8px;color:#f6e8b1}
    .about-sub{font-size:14px;color:#a0a0a0;margin-bottom:16px}
    .about-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px}
    .about-card{background:#0e0e0e;border:1px solid rgba(212,175,55,.15);border-radius:16px;padding:16px}
    .about-bullets{list-style:none;padding:0;margin:12px 0 0 0}
    .about-bullets li{margin:6px 0;padding-left:18px;position:relative}
    .about-bullets li:before{content:"✅";position:absolute;left:0;top:0.5px}
    blockquote.about-quote{margin:12px 0;border-left:4px solid rgba(212,175,55,.5);padding:8px 12px;color:#e9e1c8;font-style:italic}
    .small-muted{font-size:12px;color:#9a9a9a;margin-top:8px}

    .btn-row{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-top:.6rem}
    .btn-gold{background:var(--gold);color:#000;border-radius:.7rem;padding:.55rem .9rem;font-weight:800;border:0;cursor:pointer}
    .select-net{margin:8px 0;padding:.45rem .6rem;border-radius:.6rem;border:1px solid var(--border);background:#0f0e0c;color:var(--text)}
    .mint-log{background:#0f0e0c;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:10px;color:#ddd;font-size:.85rem;min-height:2.2em}

    #roadmap .grid{grid-template-columns:repeat(4,1fr)}
    #roadmap .roadmap-card{transition:transform .25s ease, box-shadow .25s ease}
    #roadmap .roadmap-card:hover{transform:translateY(-4px); box-shadow:0 4px 15px rgba(212,175,55,.15)}
    @media(max-width:900px){ #roadmap .grid{grid-template-columns:repeat(2,1fr)} }

    /* --- 추가: 차트 & 알림 스타일 --- */
    #chart-box{margin-top:12px;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#0f0f0f}
    .chart-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
    .chart-body{height:520px}
    .chart-body iframe{width:100%;height:100%;border:0;display:block}
    .alert-wrap{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .alert-wrap input{width:100%;padding:.6rem .7rem;border-radius:.6rem;border:1px solid var(--border);background:#0f0e0c;color:var(--text)}
    .alert-hint{font-size:.85rem;color:var(--muted)}
    @media(max-width:700px){ .alert-wrap{grid-template-columns:1fr} .chart-body{height:420px} }
  </style>

  <!-- ethers CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.12.1/dist/ethers.umd.min.js"></script>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="brand" id="brand">$FLEX is your life. Your life is FLEX.</div>
    <div class="spacer"></div>
    <div class="nav">
      <a href="#about-flexcoin">About</a>
      <a href="#whitepaper">Whitepaper</a>
      <a href="#roadmap">Roadmap</a>
      <a href="#nft">NFT</a>
    </div>
    <a id="btn-x" class="btn" href="#" target="_blank" rel="noopener">X</a>
    <a id="btn-tg" class="btn" href="#" target="_blank" rel="noopener">Telegram</a>
    <a id="btn-pcs" class="btn" href="#" target="_blank" rel="noopener">Buy on PancakeSwap</a>
    <div class="lang" aria-label="language" id="lang-pill">
      <button data-lang="en" class="active">EN</button><button data-lang="ko">KR</button>
    </div>
  </div>

  <div class="wrap">
    <!-- HERO -->
    <section class="card hero">
      <img id="hero-img" src="/public/hero/main.jpg" alt="Flexcoin hero" onerror="this.onerror=null;this.src='/public/hero/1.jpg'">
    </section>

    <!-- About -->
    <section id="about-flexcoin" class="about-section">
      <div class="about-title">About FlexCoin</div>
      <div class="about-sub">감성 + 신뢰 결합 (Korean & English)</div>
      <div class="about-grid">
        <div class="about-card">
          <h3 style="margin:0 0 8px 0">한국어</h3>
          <p>FlexCoin은 단순한 밈코인이 아닙니다. 한국에서 “Flex”는 <b>자신의 능력·소비력·자신감</b>을 당당하게 표현하는 문화입니다. FlexCoin은 그 태도를 담은 <b>라이프스타일</b>입니다.</p>
          <blockquote class="about-quote">“Flex는 과시가 아니라, 당신의 삶을 증명하는 것이다.”</blockquote>
          <p>우리는 투명함을 선택했고, 그 투명함이 신뢰를 만든다고 믿습니다.</p>
          <ul class="about-bullets">
            <li><b>팀 신원 KYC 인증</b></li>
            <li><b>스마트 컨트랙트 Audit(감사)</b></li>
            <li><b>유동성 LP Lock + 소유권 포기</b></li>
            <li><b>Tokenomics · 지갑 배분 100% 공개</b></li>
          </ul>
          <p class="small-muted">모든 항목은 온체인으로 증명됩니다.</p>
        </div>
        <div class="about-card">
          <h3 style="margin:0 0 8px 0">English</h3>
          <p>FlexCoin isn’t just a memecoin. In Korea, “Flex” means proudly expressing your <b>capability, spending power, and confidence</b>. FlexCoin captures that <b>lifestyle</b>.</p>
          <blockquote class="about-quote">“Flexing isn’t showing off — it’s owning your story.”</blockquote>
          <p>We choose transparency, because transparency creates trust.</p>
          <ul class="about-bullets">
            <li><b>Team KYC Verified</b></li>
            <li><b>Smart Contract Audit Completed</b></li>
            <li><b>LP Locked + Ownership Renounced</b></li>
            <li><b>100% Public Tokenomics & Wallet Allocation</b></li>
          </ul>
          <p class="small-muted">Everything is verifiable on-chain.</p>
        </div>
      </div>
    </section>

    <!-- Tokenomics -->
    <section class="card">
      <div class="section-title" data-i18n="section_tokenomics">Tokenomics</div>
      <div class="tok-wrap">
        <canvas id="donut" width="300" height="300" aria-label="Tokenomics donut"></canvas>
        <div>
          <ul class="legend" id="legend"></ul>
          <div id="caps" class="muted"></div>
          <div id="rates" class="muted"></div>

          <!-- 두 개의 프리세일 버튼 -->
          <div class="btn-row" style="justify-content:flex-start;margin-top:12px">
            <a id="btn-presale-1" class="btn" aria-disabled="true">Presale #1 (coming soon)</a>
            <a id="btn-presale-2" class="btn" aria-disabled="true">Presale #2 (coming soon)</a>
          </div>

          <!-- 상세 설명: 비율 + 락업 안내 -->
          <div id="tokenomics-note" class="tokenomics-note"></div>
        </div>
      </div>
    </section>

    <!-- Countdown -->
    <section class="card">
      <div class="section-title">Presale Countdown</div>
      <div class="countbox">
        <div id="countdown">—</div>
        <div id="countdown-range" class="muted">—</div>
      </div>
    </section>

    <!-- Action Preview -->
    <section class="card">
      <div class="section-title">Action Preview</div>
      <div class="grid" id="action-grid"></div>
    </section>

    <!-- NFT Preview -->
    <section class="card">
      <div class="section-title" data-i18n="nft.title">NFT Preview</div>
      <div class="grid" id="nft-grid"></div>
    </section>

    <!-- Whitepaper -->
    <section id="whitepaper" class="card">
      <div class="section-title">Whitepaper</div>
      <div class="wp-grid">
        <a class="btn" href="/public/whitepaper/en.pdf" download target="_blank" rel="noopener">English</a>
        <a class="btn" href="/public/whitepaper/ko.pdf" download target="_blank" rel="noopener">Korean</a>
        <a class="btn" href="/public/whitepaper/ja.pdf" download target="_blank" rel="noopener">Japanese</a>
        <a class="btn" href="/public/whitepaper/zh.pdf" download target="_blank" rel="noopener">Chinese</a>
        <a class="btn" href="/public/whitepaper/es.pdf" download target="_blank" rel="noopener">Spanish</a>
        <a class="btn" href="/public/whitepaper/de.pdf" download target="_blank" rel="noopener">German</a>
        <a class="btn" href="/public/whitepaper/pt.pdf" download target="_blank" rel="noopener">Portuguese</a>
        <a class="btn" href="/public/whitepaper/it.pdf" download target="_blank" rel="noopener">Italian</a>
      </div>
      <div class="muted wp-note">※ 다운로드가 막히면 새 탭에서 열림 → “다른 이름으로 저장”.</div>
    </section>

    <!-- Addresses -->
    <section class="card addr">
      <div class="section-title">Addresses</div>
      <table id="addr-table"></table>
    </section>

    <!-- Roadmap (i18n) -->
    <section id="roadmap" class="card">
      <div class="section-title" data-i18n="roadmap.title">Roadmap</div>
      <div class="grid">
        <div class="roadmap-card card">
          <div class="muted" data-i18n="roadmap.phase1.title">Phase 1</div>
          <div style="font-weight:800;margin-top:.2rem" data-i18n="roadmap.phase1.desc">
            Successful Launch & Survive in the Memecoin Sector
          </div>
        </div>
        <div class="roadmap-card card">
          <div class="muted" data-i18n="roadmap.phase2.title">Phase 2</div>
          <div style="font-weight:800;margin-top:.2rem" data-i18n="roadmap.phase2.desc">
            Community Activation & Achieve 1,000 Holders
          </div>
        </div>
        <div class="roadmap-card card">
          <div class="muted" data-i18n="roadmap.phase3.title">Phase 3</div>
          <div style="font-weight:800;margin-top:.2rem" data-i18n="roadmap.phase3.desc">
            DEX & CEX Exchange Listings
          </div>
        </div>
        <div class="roadmap-card card">
          <div class="muted" data-i18n="roadmap.phase4.title">Phase 4</div>
          <div style="font-weight:800;margin-top:.2rem" data-i18n="roadmap.phase4.desc">
            Ecosystem Expansion (AI & NFT)
          </div>
        </div>
      </div>
    </section>

    <!-- NFT MINT -->
    <section id="nft" class="card">
      <div class="section-title" data-i18n="section_nft">FLEX NFT MINT</div>
      <p class="muted" style="margin-top:-6px">Mint your official <b>FlexNFT</b> on BNB Smart Chain <b>(coming soon)</b></p>
      <div style="text-align:center;">
        <select id="net" class="select-net">
          <option value="bscMainnet">BNB Mainnet</option>
          <option value="bscTestnet">BNB Testnet</option>
        </select>
        <div class="btn-row">
          <button id="connect" class="btn-gold" data-i18n="connect">Connect Wallet</button>
          <button id="mint" class="btn-gold" disabled>Mint NFT (Legacy)</button>
          <button id="mint-flex" class="btn-gold" disabled>Mint FlexNFT (0.0001 BNB)</button>
        </div>
        <pre id="mint-log" class="mint-log">[ Waiting for connection... ]</pre>
      </div>

      <!-- Live Chart box -->
      <div id="chart-box">
        <div class="chart-head">
          <div><b>Live Price / Chart</b></div>
          <div class="muted" id="chart-hint">Dexscreener embed will show here if configured.</div>
        </div>
        <div class="chart-body" id="chart-body">
          <!-- runtime에서 links.dexscreener_url 있으면 iframe 주입 -->
        </div>
      </div>
    </section>

    <!-- Alerts -->
    <section id="alerts" class="card">
      <div class="section-title">Alerts</div>
      <div class="alert-wrap">
        <input id="alert-email" type="email" placeholder="Email address" autocomplete="email">
        <input id="alert-tg" type="text" placeholder="Telegram @handle (optional)" autocomplete="off">
      </div>
      <div class="btn-row">
        <button id="alert-submit" class="btn">Notify me</button>
      </div>
      <div id="alert-msg" class="alert-hint">Enter your email to get presale & listing alerts. (coming soon if backend not set)</div>
    </section>
  </div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" aria-modal="true" role="dialog">
    <div class="lb-toolbar">
      <button class="btn" id="lb-zoom-in">+</button>
      <button class="btn" id="lb-zoom-out">−</button>
      <button class="btn" id="lb-reset">75%</button>
      <button class="btn" id="lb-close">Close</button>
    </div>
    <div class="lb-hint">Wheel/핀치로 확대, 드래그로 이동, ESC 닫기</div>
    <div class="lb-stage" id="lb-stage">
      <img id="lb-img" class="lb-img" alt="preview">
    </div>
  </div>

  <script>
    const $ = (q)=>document.querySelector(q);

    /* ---------------- Whitepaper Direct Router ---------------- */
    (function directWhitepaperRouter(){
      const langCodes = ['en','ko','ja','zh','es','de','pt','it'];
      const lower = (s)=> (s||'').toLowerCase();
      function findBestPdf(code){
        const tryList = [`/public/whitepaper/${code}.pdf`,`/whitepaper/${code}.pdf`];
        return Promise.all(tryList.map(p=>fetch(p,{method:'HEAD',cache:'no-cache'}).then(r=>r.ok?p:null).catch(()=>null)))
          .then(arr=>arr.find(Boolean));
      }
      async function handlePath(){
        const p = lower(location.pathname);
        const m = p.match(/^\/(whitepaper|wp|pdf)(?:\/)?([a-z]{2})?(?:\.pdf)?$/);
        if(!m) return false;
        const code = (m[2] && langCodes.includes(m[2])) ? m[2] : 'ko';
        const url = await findBestPdf(code);
        if(url){
          const a = document.createElement('a'); a.href = url; a.download = `flexcoin_whitepaper_${code}.pdf`;
          document.body.appendChild(a); a.click(); a.remove();
          window.open(url,'_blank','noopener'); return true;
        }
        return false;
      }
      async function handleHash(){
        const h = lower(location.hash);
        const mh = h.match(/^#(?:whitepaper|pdf)(?:[-_]?([a-z]{2}))?$/);
        let code = mh ? (mh[1] || 'ko') : null;
        if(!code) return false;
        const url = await findBestPdf(code);
        if(url){
          const a = document.createElement('a'); a.href = url; a.download = `flexcoin_whitepaper_${code}.pdf`;
          document.body.appendChild(a); a.click(); a.remove();
          window.open(url,'_blank','noopener'); return true;
        }
        return false;
      }
      handlePath().then(hit=>{ if(!hit) handleHash(); });
      window.addEventListener('hashchange', handleHash);
    })();

    /* --------- 유틸 --------- */
    const deep = (obj, path) => path.split('.').reduce((o,k)=> (o && k in o) ? o[k] : undefined, obj);
    async function fetchFirst(paths){ for(const p of paths){ try{ const r=await fetch(p,{cache:'no-cache'}); if(r.ok) return r.json(); }catch(_){} } return {}; }
    function firstExistingImage(paths){
      return new Promise(resolve=>{
        let i=0; const next=()=>{ if(i>=paths.length) return resolve(null);
          const img=new Image(); img.onload=()=>resolve(paths[i]); img.onerror=()=>{ i++; next(); }; img.src=paths[i]; };
        next();
      });
    }
    async function firstExistingFile(paths){
      for(const p of paths){ try{ const r=await fetch(p,{method:'HEAD',cache:'no-cache'}); if(r.ok) return p; }catch(_){} }
      return null;
    }

    /* --------- 링크/주소 + 차트 + 알림 --------- */
    async function initLinks(){
      const links = await fetchFirst(['/public/config/links.json','/config/links.json']);
      const set=(id,url)=>{const b=$(id); if(!b) return; if(url){b.href=url; b.removeAttribute('disabled');} else {b.setAttribute('disabled','');}};
      set('#btn-x',links.x_url); set('#btn-tg',links.tg_url); set('#btn-pcs',links.pancakeswap_url);

      const addr = await fetchFirst(['/public/config/addresses.json','/config/addresses.json']);
      const toScan=(a)=>a?`https://bscscan.com/address/${a}`:'#';
      const rows=[['Token',addr.token],['Team/Lock',addr.team_lock||addr.team],['Marketing',addr.marketing],
                  ['Presale',addr.presale],['Burn',addr.burn],['User',addr.user]];
      $('#addr-table').innerHTML = rows.map(([k,v])=>`<tr><td>${k}</td><td><a href="${toScan(v)}" target="_blank" rel="noopener">${v||''}</a></td></tr>`).join('');

      /* 차트 임베드 */
      const chartBody = $('#chart-body');
      const hint = $('#chart-hint');
      let dexUrl = links.dexscreener_url || '';
      if(!dexUrl){
        const cmc = `https://dex.coinmarketcap.com/ko/token/bsc/${addr.token||''}/`;
        chartBody.innerHTML = `<div style="padding:18px;text-align:center">
          <div class="muted" style="margin-bottom:10px">Dexscreener URL이 설정되어 있지 않습니다.</div>
          <a class="btn" href="${cmc}" target="_blank" rel="noopener">Open CMC DEX Chart</a>
        </div>`;
        hint.textContent = 'CMC는 보안정책으로 iframe 임베드가 불가하여 새 탭으로 열립니다.';
      }else{
        chartBody.innerHTML = `<iframe src="${dexUrl}${dexUrl.includes('?')?'&':'?'}embed=1&theme=dark" loading="lazy"></iframe>`;
        hint.textContent = 'Powered by Dexscreener';
      }

      /* Alerts 폼 제출 */
      const formEndpoint = links.form_endpoint || '';
      const btn = $('#alert-submit');
      btn.onclick = async ()=>{
        const email = $('#alert-email').value.trim();
        const tg = $('#alert-tg').value.trim();
        const msg = $('#alert-msg');
        if(!email){ msg.textContent = 'Please enter your email.'; return; }
        if(!formEndpoint){ msg.textContent = 'Alerts backend not set (coming soon).'; return; }
        try{
          const r = await fetch(formEndpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,tg,ts:new Date().toISOString(),source:'flexcoin'})});
          if(r.ok){ msg.textContent='Subscribed! We will notify you.'; $('#alert-email').value=''; $('#alert-tg').value=''; }
          else{ msg.textContent='Submit failed. Please try again later.'; }
        }catch(e){ msg.textContent='Network error. Please try again.'; }
      };
    }

    /* --------- 히어로 이미지 --------- */
    async function initHero(){
      const src = await firstExistingImage(['/public/hero/main.jpg','/hero/main.jpg','/public/hero/1.jpg','/hero/1.jpg']);
      if(src){ const img=$('#hero-img'); img.src=src; }
    }

    /* --------- 토크노믹스 --------- */
    async function initTokenomics(){
      const j = await fetchFirst(['/public/config/allocations.json','/config/allocations.json']);

      // 기본값: LP54 / Presale20 / Team15 / Marketing10 / Burn1
      const t = j.tokenomics || {lp:54,presale:20,team:15,marketing:10,burn:1};

      const canvas = $('#donut');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');

      const vals=[t.lp,t.presale,t.team,t.marketing,t.burn];
      const names=['LP','Presale','Team','Marketing','Burn'];
      const cols=['#ffd85a','#ff944d','#53d878','#4da1ff','#ff6b6b'];

      const w = canvas.width;
      const h = canvas.height;
      const size = Math.min(w,h);
      const cx = w/2;
      const cy = h/2;
      const outerR = size*0.46;
      const innerR = size*0.27;

      ctx.clearRect(0,0,w,h);

      let start = -Math.PI/2;
      vals.forEach((v,i)=>{
        const ratio = (v||0)/100;
        const end = start + 2*Math.PI*ratio;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,outerR,start,end);
        ctx.closePath();
        ctx.fillStyle = cols[i];
        ctx.fill();
        start = end;
      });

      // 가운데 구멍
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(cx,cy,innerR,0,2*Math.PI);
      ctx.fill();
      ctx.globalCompositeOperation = 'source-over';

      // 범례
      $('#legend').innerHTML = names.map((n,i)=>`
        <li><span class="legend-dot" style="background:${cols[i]}"></span>${n} ${vals[i]}%</li>
      `).join('');

      // Soft / Hard cap & Rate
      const p = j.presale || {};
      const soft = p.softcap_bnb ?? j.softcap ?? '—';
      const hard = p.hardcap_bnb ?? j.hardcap ?? '—';
      $('#caps').textContent=`Softcap: ${soft} BNB / Hardcap: ${hard} BNB`;

      const pres = Number(p.rate_flex_per_bnb ?? (j.rates?.presale||0));
      const list = Number(p.listing_rate_flex_per_bnb ?? (j.rates?.listing||0));
      const fmtN=(n)=> (Number.isFinite(n)&&n>0)? n.toLocaleString():'—';
      $('#rates').textContent=`Presale Rate: 1 BNB = ${fmtN(pres)} FLEX  •  Listing Rate: 1 BNB = ${fmtN(list)} FLEX`;

      // 상세 설명 (락업 등)
      const note = $('#tokenomics-note');
      if(note){
        const lockDays = p.lp_lock_days ?? j.lp_lock_days ?? 365;
        note.innerHTML = `
          • LP <b>${t.lp}%</b> — Dex 유동성, 최소 <b>${lockDays}일</b> 이상 락업 예정<br>
          • Presale <b>${t.presale}%</b> — GemPad / Pinksale 등 런치패드 프리세일 물량<br>
          • Team <b>${t.team}%</b> — 장기 팀·개발자 물량 (베스팅 스케줄 공지 예정)<br>
          • Marketing <b>${t.marketing}%</b> — 마케팅, 파트너십, 상장 수수료 등에만 사용
        `;
      }

      // 프리세일 버튼 2개 (links.json 기반)
      const links = await fetchFirst(['/public/config/links.json','/config/links.json']);
      const btn1 = $('#btn-presale-1');
      const btn2 = $('#btn-presale-2');

      function wire(btn,url,label){
        if(!btn) return;
        if(url){
          btn.textContent = label;
          btn.href = url;
          btn.removeAttribute('aria-disabled');
          btn.target = '_blank';
          btn.rel = 'noopener';
        }else{
          btn.textContent = `${label} (coming soon)`;
          btn.removeAttribute('href');
          btn.setAttribute('aria-disabled','true');
        }
      }

      wire(btn1, links.pinksale_url || '', 'Pinksale Presale');
      wire(btn2, links.gempad_url || links.alt_presale_url || '', 'GemPad Presale');
    }

    /* --------- 카운트다운 --------- */
    async function initCountdown(){
      let sISO='2025-12-18T21:00:00+09:00', eISO='2026-01-01T21:00:00+09:00';
      const p = await fetchFirst(['/public/config/presale.json','/config/presale.json']);
      if(p.presale_start||p.start){ const x=(p.presale_start||p.start); sISO=x+(String(x).includes('+')?'':'+09:00'); }
      if(p.presale_end||p.end){ const y=(p.presale_end||p.end); eISO=y+(String(y).includes('+')?'':'+09:00'); }
      const s=new Date(sISO), e=new Date(eISO);
      const range=$('#countdown-range'),count=$('#countdown');
      const z=(n)=>String(n).padStart(2,'0');
      const fmt=(d)=>`${d.getFullYear()}. ${z(d.getMonth()+1)}. ${z(d.getDate())}. ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
      range.textContent=`${fmt(s)} → ${fmt(e)}`;
      const tick=()=>{ const now=new Date(); let t=s-now; if(t<0) t=e-now; if(t<=0){ count.textContent='—'; return; }
        const d=Math.floor(t/86400000); t%=86400000; const h=Math.floor(t/3600000); t%=3600000; const m=Math.floor(t/60000); t%=60000; const s2=Math.floor(t/1000);
        count.textContent=`${d}d ${z(h)}:${z(m)}:${z(s2)}`; };
      tick(); setInterval(tick,1000);
    }

    /* --------- 갤러리 --------- */
    async function loadGrid(prefix, targetId){
      const list=Array.from({length:8},(_,i)=>i+1);
      const decided=await Promise.all(list.map(n=> firstExistingImage([`/public${prefix}/${n}.jpg`, `${prefix}/${n}.jpg`])));
      const ok=decided.filter(Boolean);
      const el=$(targetId);
      el.innerHTML = ok.length ? ok.map(src=>`<img src="${src}" alt="">`).join('') : '<div class="muted">Images coming soon.</div>';
      el.querySelectorAll('img').forEach(img=>{ img.style.cursor='zoom-in'; img.addEventListener('click',()=>openLightbox(img.src)); });
    }

    /* --------- 라이트박스 --------- */
    const lb=$('#lightbox'), lbImg=$('#lb-img'), lbStage=$('#lb-stage');
    let scale=0.75, minS=0.5, maxS=6, pos={x:0,y:0}, dragging=false, startPos={x:0,y:0};
    function applyLB(){ lbImg.style.transform=`translate(${pos.x}px,${pos.y}px) scale(${scale})`; }
    function openLightbox(src){ lbImg.src=src; scale=0.75; pos={x:0,y:0}; applyLB(); lb.classList.add('show'); document.body.classList.add('noscroll'); }
    function closeLightbox(){ lb.classList.remove('show'); document.body.classList.remove('noscroll'); }
    $('#lb-close').onclick=closeLightbox; $('#lb-reset').onclick=()=>{scale=0.75;pos={x:0,y:0};applyLB();};
    $('#lb-zoom-in').onclick=()=>{ scale=Math.min(maxS,scale*1.2); applyLB(); };
    $('#lb-zoom-out').onclick=()=>{ scale=Math.max(minS,scale/1.2); applyLB(); };
    lbStage.addEventListener('wheel',(e)=>{ e.preventDefault(); const k=e.deltaY>0?1.2:1/1.2; scale=Math.min(maxS,Math.max(minS,scale*k)); applyLB(); },{passive:false});
    lbStage.addEventListener('mousedown',(e)=>{ dragging=true; lbStage.style.cursor='grabbing'; startPos={x:e.clientX-pos.x,y:e.clientY-pos.y}; });
    window.addEventListener('mousemove',(e)=>{ if(!dragging) return; pos={x:e.clientX-startPos.x,y:e.clientY-startPos.y}; applyLB(); });
    window.addEventListener('mouseup',()=>{ dragging=false; lbStage.style.cursor='grab'; });
    lb.addEventListener('click',(e)=>{ if(e.target===lb) closeLightbox(); });

    /* --------- i18n --------- */
    async function setLang(lang){
      const dict=await fetchFirst([`/public/i18n/${lang}.json`,`/i18n/${lang}.json`]);
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k=el.getAttribute('data-i18n');
        const v = deep(dict, k);
        if(v !== undefined){ el.textContent=v; }
      });
      localStorage.setItem('lang',lang);
      document.querySelectorAll('#lang-pill [data-lang]').forEach(b=>b.classList.toggle('active', b.getAttribute('data-lang')===lang));
      $('#brand').textContent='$FLEX is your life. Your life is FLEX.';
    }
    function bindLang(){
      const wanted=new URL(location.href).searchParams.get('lang')||localStorage.getItem('lang')||'en';
      setLang(wanted);
      document.querySelectorAll('#lang-pill [data-lang]').forEach(btn=> btn.addEventListener('click',()=> setLang(btn.getAttribute('data-lang')||'en')));
    }

    /* --------- NFT Mint + 메타마스크 연결 --------- */
    const CHAINS={ bscTestnet:{chainId:'0x61',name:'BSC Testnet',rpc:'https://data-seed-prebsc-1-s3.binance.org:8545'},
                   bscMainnet:{chainId:'0x38',name:'BSC',rpc:'https://bsc-dataseed.binance.org'} };
    const DEFAULT_PRICE_BNB = (window.NFT_PRICE_BNB || '0.0001');
    const ABI_VARIANTS = [
      ["function claim(address receiver, uint256 quantity) payable","function price() view returns (uint256)"],
      ["function claim(uint256 quantity) payable","function price() view returns (uint256)"],
      ["function mint(uint256 quantity) payable","function price() view returns (uint256)"]
    ];
    let NFT_ADDR={ bscMainnet:'0xYourMainnetNFTAddress', bscTestnet:'0xYourTestnetNFTAddress' };

    let signer = null;

    function setMintButtons(enabled){
      const b1=$('#mint'), b2=$('#mint-flex');
      [b1,b2].forEach(b=>{ if(!b) return; if(enabled){ b.removeAttribute('disabled'); } else { b.setAttribute('disabled',''); } });
    }

    function short(a){ return a ? (a.slice(0,6)+'…'+a.slice(-4)) : ''; }

    async function ensureChain(chainKey){
      const { ethereum } = window;
      if(!ethereum) throw new Error('MetaMask not installed.');
      const target=CHAINS[chainKey];
      try{
        await ethereum.request({method:'wallet_switchEthereumChain',params:[{chainId:target.chainId}]});
      }catch(e){
        if(e && e.code===4902){
          await ethereum.request({method:'wallet_addEthereumChain',
            params:[{chainId:target.chainId,chainName:target.name,rpcUrls:[target.rpc],nativeCurrency:{name:'BNB',symbol:'BNB',decimals:18}}]});
        }else{ throw e; }
      }
    }

    async function connectWallet(){
      const netSel = $('#net').value;
      await ensureChain(netSel);
      const provider=new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      const addr = await signer.getAddress();
      $('#connect').textContent = 'Connected: '+short(addr);
      $('#mint-log').textContent = 'Connected: '+addr;
      setMintButtons(true);
      return signer;
    }

    function bindWalletEvents(){
      if(!window.ethereum) return;
      window.ethereum.on('accountsChanged', async (accs)=>{
        if(!accs || accs.length===0){ $('#connect').textContent='Connect Wallet'; setMintButtons(false); $('#mint-log').textContent='[ Waiting for connection... ]'; signer=null; return; }
        const addr = accs[0]; $('#connect').textContent='Connected: '+short(addr); $('#mint-log').textContent='Account: '+addr;
      });
      window.ethereum.on('chainChanged', async (_hex)=>{
        const v = _hex==='0x38'?'bscMainnet':(_hex==='0x61'?'bscTestnet':null);
        if(v){ $('#net').value = v; }
        if(signer){ try{ await connectWallet(); }catch(_){ } }
      });
      window.ethereum.on('disconnect', ()=>{
        $('#connect').textContent='Connect Wallet'; setMintButtons(false); $('#mint-log').textContent='[ Waiting for connection... ]'; signer=null;
      });
    }

    async function setupMintUI(){
      const addr=await fetchFirst(['/public/config/addresses.json','/config/addresses.json']);
      if(addr.nft_mainnet) NFT_ADDR.bscMainnet=addr.nft_mainnet;
      if(addr.nft_testnet) NFT_ADDR.bscTestnet=addr.nft_testnet;

      setMintButtons(false);
      bindWalletEvents();

      $('#connect').onclick = async()=>{
        try{ await connectWallet(); }
        catch(e){ $('#mint-log').textContent = 'Connect error: ' + (e.message||e); }
      };

      async function runMint(payFixed){
        try{
          if(!signer) await connectWallet();
          const chainKey=$('#net').value;
          const to = await signer.getAddress();
          const target=NFT_ADDR[chainKey]; if(!target || target.length<20) throw new Error('NFT 컨트랙트 주소가 설정되지 않았습니다.');

          let last;
          for(const abi of ABI_VARIANTS){
            try{
              const c=new ethers.Contract(target, abi, signer);
              let value;
              if(payFixed){ value=ethers.parseEther(DEFAULT_PRICE_BNB); }
              else { try{ value=await c.price(); }catch{ value=ethers.parseEther(DEFAULT_PRICE_BNB); } }

              let tx;
              if(c.claim){
                try{ tx=await c.claim(to,1,{value,type:0}); }
                catch{ tx=await c.claim(1,{value}); }
              }else if(c.mint){
                tx=await c.mint(1,{value,type:0});
              }else{ throw new Error('지원하지 않는 민팅 방식'); }

              $('#mint-log').textContent = 'Minting... TX: ' + tx.hash;
              await tx.wait();
              $('#mint-log').textContent = '✅ Minted!';
              return;
            }catch(e){ last=e; }
          }
          throw last || new Error('민팅 실패');
        }catch(e){
          $('#mint-log').textContent = 'Mint error: ' + ((e&&e.message)||String(e));
        }
      }

      $('#mint').onclick = ()=>runMint(false);
      $('#mint-flex').onclick = ()=>runMint(true);
    }

    /* --------- Boot --------- */
    (async()=>{
      bindLang();
      await initLinks();
      await initHero();
      await initTokenomics();
      await initCountdown();
      await loadGrid('/action', '#action-grid');
      await loadGrid('/nft-preview', '#nft-grid');
      await setupMintUI();
    })();
  </script>
</body>
</html>
